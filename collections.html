<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collections</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Scheduled Collections</h1>
        <div class="button-container">
            <button onclick="clearCollected()">Clear Collected Donations</button>
            <button onclick="goHome()">Home</button>
        </div>
        <table id="collectionsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Area</th>
                    <th>Available Time</th>
                    <th>Contact Number</th>
                    <th>Alternative Contact Name</th>
                    <th>Alternative Contact Number</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="collectionsBody">
                <!-- Collections will be populated here -->
            </tbody>
        </table>
    </div>

    <div id="collectionCountMessage"></div>

    <footer>
        @ 2024 Shakes_Warrior Donation Collection Manager - Developed by Soft Serv Supplies (Pty) Ltd.
    </footer>

    <!-- Include Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.js"></script>
    <!-- Include script.js file -->
    <script src="script.js"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://ritieslzfvjxgpfayzzg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdGllc2x6ZnZqeGdwZmF5enpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQ1MTYwNzUsImV4cCI6MjA0MDA5MjA3NX0.2FWU35eUL470Jx6FsKEaM9IXcWJSLpnRgTSI56YgXsY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function loadCollections() {
            try {
                const { data, error } = await supabase
                    .from('Collections') // Your table name
                    .select('*');

                if (error) throw error;

                const tableBody = document.getElementById('collectionsBody');
                tableBody.innerHTML = '';

                // Sort donations by the 'Area' field
                data.sort((a, b) => {
                    if (a.Area < b.Area) return -1;
                    if (a.Area > b.Area) return 1;
                    return 0;
                });

                let pendingCount = 0; // Initialize the counter for pending collections

                data.forEach((donation, index) => {
                    const row = document.createElement('tr');

                    Object.keys(donation).forEach(key => {
                        const cell = document.createElement('td');

                        if (key === 'Address') {
                            // Create a Google Maps link for the address
                            const addressLink = document.createElement('a');
                            addressLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(donation.Address)}`;
                            addressLink.textContent = donation.Address;
                            addressLink.target = '_blank'; // Open in a new tab
                            cell.appendChild(addressLink);
                        } else {
                            cell.textContent = donation[key];
                        }

                        row.appendChild(cell);
                    });

                    // Add status dropdown
                    const statusCell = document.createElement('td');
                    const statusSelect = document.createElement('select');
                    statusSelect.innerHTML = `
                        <option value="Pending Collection" ${donation.Status === 'Pending Collection' ? 'selected' : ''}>Pending Collection</option>
                        <option value="Collected" ${donation.Status === 'Collected' ? 'selected' : ''}>Collected</option>
                    `;
                    statusSelect.addEventListener('change', async function() {
                        try {
                            const { data, error } = await supabase
                                .from('Collections')
                                .update({ Status: this.value })
                                .eq('id', donation.id); // Assuming you have a unique ID for each record
                            
                            if (error) throw error;

                            loadCollections(); // Reload the table and update the count message
                        } catch (error) {
                            console.error('Error updating status:', error.message);
                        }
                    });
                    statusCell.appendChild(statusSelect);
                    row.appendChild(statusCell);

                    tableBody.appendChild(row);

                    // Increment the pending count if the status is "Pending Collection"
                    if (donation.Status === 'Pending Collection') {
                        pendingCount++;
                    }
                });

                // Display the pending count message
                const collectionCountMessage = document.getElementById('collectionCountMessage');
                collectionCountMessage.textContent = `You have ${pendingCount} donations to be collected.`;

            } catch (error) {
                console.error('Error loading collections:', error.message);
            }
        }

        async function clearCollected() {
            try {
                const { data, error } = await supabase
                    .from('Collections')
                    .delete()
                    .eq('Status', 'Collected');

                if (error) throw error;

                loadCollections(); // Refresh the table
            } catch (error) {
                console.error('Error clearing collected donations:', error.message);
            }
        }

        // Load collections on page load
        window.onload = loadCollections;

        function goHome() {
            window.location.href = 'index.html'; // Replace with the correct path if different
        }
    </script>
</body>
</html>
